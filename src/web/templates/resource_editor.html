<!DOCTYPE html>
<html lang="en">
<head>
  <<<head_block>>>
  <title>Edit {{type}} {{shortname}} — fj</title>
</head>
<body class="font-sans bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col">

  <<<html_nav>>>

  <!-- Main Content Section -->
  <main id="main-content" class="container mx-auto p-4 flex-grow">

    {{#committed}}
    <div class="bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-600 text-green-700 dark:text-green-200 px-4 py-3 rounded-lg mb-6">
      <strong class="font-bold">{{type}} committed successfully!</strong>
    </div>
    {{/committed}}

    <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">
      Edit {{type}} <span class="font-normal text-gray-600 dark:text-gray-400">{{shortname}}</span>
    </h2>

    <form action="/{{type}}/commit/{{shortname}}" method="post">
      <input type="hidden" name="_csrf" value="{{csrf_token}}" />

      <div class="bg-white dark:bg-gray-900 p-6 rounded-lg shadow-md dark:shadow-2xl dark:shadow-gray-900/50 border border-gray-200 dark:border-gray-700 mb-8">
        <div class="flex-1 min-w-0">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">{{type}} {{shortname}}.json</h3>
            {{#editable}}
            <button type="button" id="toggle-json-view" onclick="toggleJsonView()"
                    class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium">
              Show Raw JSON
            </button>
            {{/editable}}
          </div>

          <!-- Raw JSON textarea (hidden when form is active, always the submission payload) -->
          <div id="raw-json-panel" style="{{#editable}}display:none;{{/editable}}">
            <textarea id="json-editor" name="json" {{^editable}}readonly{{/editable}}
                      class="w-full h-96 md:h-72 font-mono text-sm p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:focus:ring-blue-500 dark:focus:border-blue-500 shadow-sm resize-y bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100">{{json}}</textarea>
          </div>

          <!-- Structured form (shown by default when editable) -->
          {{#editable}}
          <div id="structured-form-panel" class="space-y-4">

            <!-- CLIENT FIELDS -->
            {{#is_client}}
            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Client Details</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Shortname</label>
                  <input type="text" data-json-path="shortname" readonly class="w-full p-2 text-sm border border-gray-200 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800 text-gray-500 dark:text-gray-400" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Company Name</label>
                  <input type="text" data-json-path="company-name" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">c/o Name</label>
                  <input type="text" data-json-path="c/o-name" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Street</label>
                  <input type="text" data-json-path="street" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
              <div class="grid grid-cols-3 gap-3 mt-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Area Code</label>
                  <input type="text" data-json-path="areacode" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">City</label>
                  <input type="text" data-json-path="city" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Country</label>
                  <input type="text" data-json-path="country" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Tax UID</label>
                  <input type="text" data-json-path="tax_uid" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Remarks</label>
                  <input type="text" data-json-path="remarks" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
            </fieldset>
            {{/is_client}}

            <!-- RATE FIELDS -->
            {{#is_rate}}
            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Rate Details</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Shortname</label>
                  <input type="text" data-json-path="shortname" readonly class="w-full p-2 text-sm border border-gray-200 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800 text-gray-500 dark:text-gray-400" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Hourly Rate</label>
                  <input type="number" data-json-path="hourly" data-json-type="number" step="0.01" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
              <div class="grid grid-cols-3 gap-3 mt-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Hours/Day</label>
                  <input type="number" data-json-path="hours_per_day" data-json-type="number" step="0.5" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Daily Rate</label>
                  <input type="number" data-json-path="daily" data-json-type="number" step="0.01" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Weekly Rate</label>
                  <input type="number" data-json-path="weekly" data-json-type="number" step="0.01" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
              <div class="mt-3">
                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Remarks</label>
                <input type="text" data-json-path="remarks" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
              </div>
            </fieldset>
            {{/is_rate}}

          </div>
          {{/editable}}
        </div>

        <div class="flex flex-wrap gap-4 mt-6">
          {{#editable}}
          <button type="submit"
                  class="bg-green-600 dark:bg-green-600 hover:bg-green-700 dark:hover:bg-green-500 text-white dark:text-white font-semibold py-2 px-4 rounded-md shadow-sm cursor-pointer transition-colors duration-200">
            Commit
          </button>
          {{/editable}}
          {{^editable}}
          <a href="/{{type}}/edit/{{shortname}}"
             class="bg-blue-600 dark:bg-blue-600 hover:bg-blue-700 dark:hover:bg-blue-500 text-white dark:text-white font-semibold py-2 px-4 rounded-md shadow-sm cursor-pointer transition-colors duration-200 inline-block text-center">
            Edit
          </a>
          {{/editable}}
        </div>
      </div>
    </form>
  </main>

  <script>
  (function() {
    var jsonTextarea = document.getElementById('json-editor');
    if (!jsonTextarea) return;

    // Parse JSON, populate form fields
    function populateFormFromJson() {
      var data;
      try { data = JSON.parse(jsonTextarea.value); } catch(e) { return; }
      document.querySelectorAll('[data-json-path]').forEach(function(el) {
        var path = el.getAttribute('data-json-path');
        var val = getNestedValue(data, path);
        if (val === undefined || val === null) return;
        var jsonType = el.getAttribute('data-json-type');
        if (jsonType === 'bool') {
          el.checked = !!val;
        } else {
          el.value = val;
        }
      });
    }

    // Serialize form fields back to JSON
    function serializeFormToJson() {
      var data;
      try { data = JSON.parse(jsonTextarea.value); } catch(e) { data = {}; }
      document.querySelectorAll('[data-json-path]').forEach(function(el) {
        var path = el.getAttribute('data-json-path');
        var jsonType = el.getAttribute('data-json-type');
        var val;
        if (jsonType === 'bool') {
          val = el.checked;
        } else if (jsonType === 'number') {
          val = el.value === '' ? 0 : Number(el.value);
        } else {
          val = el.value;
          // Preserve null for optional fields — don't convert null to ""
          if (val === '' && getNestedValue(data, path) === null) {
            val = null;
          }
        }
        setNestedValue(data, path, val);
      });
      jsonTextarea.value = JSON.stringify(data, null, 2);
    }

    // Get nested value by dot path (handles hyphens in keys)
    function getNestedValue(obj, path) {
      var keys = path.split('.');
      var current = obj;
      for (var i = 0; i < keys.length; i++) {
        if (current === undefined || current === null) return undefined;
        current = current[keys[i]];
      }
      return current;
    }

    // Set nested value by dot path
    function setNestedValue(obj, path, value) {
      var keys = path.split('.');
      var current = obj;
      for (var i = 0; i < keys.length - 1; i++) {
        if (current[keys[i]] === undefined || current[keys[i]] === null) {
          current[keys[i]] = {};
        }
        current = current[keys[i]];
      }
      current[keys[keys.length - 1]] = value;
    }

    // Toggle between form and raw JSON
    window.toggleJsonView = function() {
      var rawPanel = document.getElementById('raw-json-panel');
      var formPanel = document.getElementById('structured-form-panel');
      var toggleBtn = document.getElementById('toggle-json-view');
      if (!rawPanel || !formPanel || !toggleBtn) return;

      if (rawPanel.style.display === 'none') {
        // Switching to raw JSON — serialize form first
        serializeFormToJson();
        rawPanel.style.display = '';
        formPanel.style.display = 'none';
        toggleBtn.textContent = 'Show Form';
      } else {
        // Switching to form — populate from JSON
        populateFormFromJson();
        rawPanel.style.display = 'none';
        formPanel.style.display = '';
        toggleBtn.textContent = 'Show Raw JSON';
      }
    };

    // On form submit, serialize form to JSON textarea
    var form = jsonTextarea.closest('form');
    if (form) {
      form.addEventListener('submit', function() {
        var formPanel = document.getElementById('structured-form-panel');
        if (formPanel && formPanel.style.display !== 'none') {
          serializeFormToJson();
        }
      });
    }

    // Initial population
    populateFormFromJson();
  })();
  </script>
</body>
</html>
