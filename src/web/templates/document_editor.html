<!DOCTYPE html>
<html lang="en">
<head>
  <<<head_block>>>
  <title>Edit {{type}} {{shortname}} — fj</title>
</head>
<body class="font-sans bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col">

  <<<html_nav>>>

  <!-- Main Content Section -->
  <main id="main-content" class="container mx-auto p-4 flex-grow">

    {{#compile_success}}
    <div class="bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-600 text-green-700 dark:text-green-200 px-4 py-3 rounded-lg mb-6">
      <strong class="font-bold">PDF compiled successfully!</strong>
    </div>
    {{/compile_success}}
    {{#compile_error}}
    <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg mb-6">
      <strong class="font-bold">Compilation Error:</strong> {{compile_error}}
    </div>
    {{/compile_error}}
    {{#committed}}
    <div class="bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-600 text-green-700 dark:text-green-200 px-4 py-3 rounded-lg mb-6">
      <strong class="font-bold">Document committed and finalized!</strong>
    </div>
    {{/committed}}
    {{#created}}
    <div class="bg-blue-100 dark:bg-blue-900 border border-blue-400 dark:border-blue-600 text-blue-700 dark:text-blue-200 px-4 py-3 rounded-lg mb-6">
      <strong class="font-bold">Document created successfully!</strong>
    </div>
    {{/created}}

    <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">
      {{type}} <span id="invoice-id" class="font-normal text-gray-600 dark:text-gray-400">{{id}}</span>
    </h2>

    <form action="{{type}}/compile/{{id}}" method="post">
      <input type="hidden" name="_csrf" value="{{csrf_token}}" />

      <div class="flex flex-col lg:flex-row gap-6 mb-8">
        <div class="flex-1 min-w-0">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">{{type}}.json</h3>
            {{#editable}}
            <button type="button" id="toggle-json-view" onclick="toggleJsonView()"
                    class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium">
              Show Raw JSON
            </button>
            {{/editable}}
          </div>

          <!-- Raw JSON textarea (hidden when form is active, always the submission payload) -->
          <div id="raw-json-panel" style="{{#editable}}display:none;{{/editable}}">
            <textarea id="json-editor" name="json" {{^editable}}readonly{{/editable}}
                      class="w-full h-72 md:h-56 font-mono text-sm p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:focus:ring-blue-500 dark:focus:border-blue-500 shadow-sm resize-y bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100">{{json}}</textarea>
          </div>

          <!-- Structured form (shown by default when editable) -->
          {{#editable}}
          <div id="structured-form-panel" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">

            <!-- INVOICE FIELDS -->
            {{#is_invoice}}
            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Basic Info</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Client</label>
                  <input type="text" data-json-path="client_shortname" list="client-names" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Project</label>
                  <input type="text" data-json-path="project_name" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Date</label>
                  <input type="text" data-json-path="date" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Year</label>
                  <input type="text" data-json-path="year" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Applicable Rates</label>
                  <input type="text" data-json-path="applicable_rates" list="rate-names" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">OMS Project</label>
                  <input type="text" data-json-path="oms_project" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
            </fieldset>

            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Service Period</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">From</label>
                  <input type="text" data-json-path="leistungszeitraum" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">To</label>
                  <input type="text" data-json-path="leistungszeitraum_bis" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
            </fieldset>

            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Payment</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Terms of Payment</label>
                  <input type="text" data-json-path="terms_of_payment" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Due Date</label>
                  <input type="text" data-json-path="due_date" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
            </fieldset>

            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Cover Letter &amp; Footer</legend>
              <div class="space-y-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Greeting</label>
                  <input type="text" data-json-path="coverletter.greeting" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div class="flex items-center gap-2">
                  <input type="checkbox" data-json-path="footer.show_agb" data-json-type="bool" id="show-agb" class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500" />
                  <label for="show-agb" class="text-xs font-medium text-gray-600 dark:text-gray-400">Show AGB</label>
                </div>
              </div>
            </fieldset>

            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">VAT</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">VAT Percent</label>
                  <input type="number" data-json-path="vat.percent" data-json-type="number" step="0.01" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div class="flex items-center gap-2 self-end pb-2">
                  <input type="checkbox" data-json-path="vat.show_exempt_notice" data-json-type="bool" id="vat-exempt" class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500" />
                  <label for="vat-exempt" class="text-xs font-medium text-gray-600 dark:text-gray-400">Show exempt notice</label>
                </div>
              </div>
            </fieldset>

            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Notes</legend>
              <textarea data-json-path="remarks" rows="2" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </fieldset>
            {{/is_invoice}}

            <!-- OFFER FIELDS -->
            {{#is_offer}}
            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Basic Info</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Client</label>
                  <input type="text" data-json-path="client_shortname" list="client-names" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Project</label>
                  <input type="text" data-json-path="project_name" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Date</label>
                  <input type="text" data-json-path="date" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Applicable Rates</label>
                  <input type="text" data-json-path="applicable_rates" list="rate-names" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Valid Through</label>
                  <input type="text" data-json-path="valid_thru" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Dev Time</label>
                  <input type="text" data-json-path="devtime" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
            </fieldset>

            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Cover Letter &amp; Footer</legend>
              <div class="space-y-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Greeting</label>
                  <input type="text" data-json-path="coverletter.greeting" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div class="flex items-center gap-2">
                  <input type="checkbox" data-json-path="coverletter.show_rates" data-json-type="bool" id="show-rates" class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500" />
                  <label for="show-rates" class="text-xs font-medium text-gray-600 dark:text-gray-400">Show Rates</label>
                </div>
                <div class="flex items-center gap-2">
                  <input type="checkbox" data-json-path="footer.show_allnetto" data-json-type="bool" id="show-allnetto" class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500" />
                  <label for="show-allnetto" class="text-xs font-medium text-gray-600 dark:text-gray-400">Show All Netto</label>
                </div>
              </div>
            </fieldset>

            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">VAT</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">VAT Percent</label>
                  <input type="number" data-json-path="vat.percent" data-json-type="number" step="0.01" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div class="flex items-center gap-2 self-end pb-2">
                  <input type="checkbox" data-json-path="vat.show_exempt_notice" data-json-type="bool" id="offer-vat-exempt" class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500" />
                  <label for="offer-vat-exempt" class="text-xs font-medium text-gray-600 dark:text-gray-400">Show exempt notice</label>
                </div>
              </div>
            </fieldset>

            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Status</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Accepted Date</label>
                  <input type="text" data-json-path="accepted_date" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Declined Date</label>
                  <input type="text" data-json-path="declined_date" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
            </fieldset>

            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Notes</legend>
              <textarea data-json-path="remarks" rows="2" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </fieldset>
            {{/is_offer}}

            <!-- LETTER FIELDS -->
            {{#is_letter}}
            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Letter Details</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Client</label>
                  <input type="text" data-json-path="client_shortname" list="client-names" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Subject</label>
                  <input type="text" data-json-path="subject" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Date</label>
                  <input type="text" data-json-path="date" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Project</label>
                  <input type="text" data-json-path="project_name" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
            </fieldset>

            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Cover Letter &amp; Footer</legend>
              <div class="space-y-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Greeting</label>
                  <input type="text" data-json-path="coverletter.greeting" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Goodbye</label>
                  <input type="text" data-json-path="footer.goodbye" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500" />
                </div>
              </div>
            </fieldset>

            <fieldset class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <legend class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2">Notes</legend>
              <textarea data-json-path="remarks" rows="2" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </fieldset>
            {{/is_letter}}

            <!-- System info (read-only, shown for all types) -->
            <div class="text-xs text-gray-400 dark:text-gray-500 space-y-1 pt-2" id="system-info">
              <!-- Populated by JS from JSON: id, created, updated, revision -->
            </div>
          </div>
          {{/editable}}
        </div>

       {{^is_letter}}
        <div class="flex-1 min-w-0">
          <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">billables.csv</h3>
          <textarea id="csv-editor" name="billables" {{^editable}}readonly{{/editable}}
                    class="w-full h-72 md:h-56 font-mono text-sm p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:focus:ring-blue-500 dark:focus:border-blue-500 shadow-sm resize-y bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100">{{billables}}</textarea>
        </div>
       {{/is_letter}}

        <div class="flex-1 min-w-0">
          <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">{{type}}.tex</h3>
          <textarea id="tex-editor" name="tex" {{^editable}}readonly{{/editable}}
                  class="w-full h-72 md:h-56 font-mono text-sm p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:focus:ring-blue-500 dark:focus:border-blue-500 shadow-sm resize-y bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100">{{{tex}}}</textarea>
        </div>
      </div>

      <div class="flex flex-wrap gap-4 mt-4">
        {{#editable}}
        <button type="submit" formaction="/{{type}}/compile/{{id}}"
                class="bg-blue-600 dark:bg-blue-600 hover:bg-blue-700 dark:hover:bg-blue-500 text-white dark:text-white font-semibold py-2 px-4 rounded-md shadow-sm cursor-pointer transition-colors duration-200">
          Compile PDF
        </button>

        <button type="submit" formaction="/{{type}}/commit/{{id}}"
                data-confirm="Commit and finalize this document? This action cannot be undone."
                class="bg-green-600 dark:bg-green-600 hover:bg-green-700 dark:hover:bg-green-500 text-white dark:text-white font-semibold py-2 px-4 rounded-md shadow-sm cursor-pointer transition-colors duration-200">
          Commit &amp; Finalize
        </button>
        {{/editable}}
      </div>
    </form>

    <datalist id="client-names">{{#client_names}}<option value="{{name}}">{{/client_names}}</datalist>
    <datalist id="rate-names">{{#rate_names}}<option value="{{name}}">{{/rate_names}}</datalist>

    <div class="mt-8">
      {{#compile}}
      <iframe id="pdf-preview" src="/{{type}}/draftpdf/{{id}}"
              class="w-full h-[75vh] md:h-[50vh] border border-gray-300 dark:border-gray-600 rounded-lg shadow-md dark:shadow-2xl dark:shadow-gray-900/50 bg-white dark:bg-gray-900"></iframe>
      {{/compile}}
      {{^compile}}
      <iframe id="pdf-preview" src="/{{type}}/pdf/{{id}}"
              class="w-full h-[75vh] md:h-[50vh] border border-gray-300 dark:border-gray-600 rounded-lg shadow-md dark:shadow-2xl dark:shadow-gray-900/50 bg-white dark:bg-gray-900"></iframe>
      {{/compile}}
    </div>
  </main>

  <script>
  (function() {
    var jsonTextarea = document.getElementById('json-editor');
    if (!jsonTextarea) return;

    // Parse JSON, populate form fields
    function populateFormFromJson() {
      var data;
      try { data = JSON.parse(jsonTextarea.value); } catch(e) { return; }
      document.querySelectorAll('[data-json-path]').forEach(function(el) {
        var path = el.getAttribute('data-json-path');
        var val = getNestedValue(data, path);
        if (val === undefined || val === null) return;
        var jsonType = el.getAttribute('data-json-type');
        if (jsonType === 'bool') {
          el.checked = !!val;
        } else {
          el.value = val;
        }
      });
      // Show system info
      var info = document.getElementById('system-info');
      if (info && data) {
        var parts = [];
        if (data.id) parts.push('ID: ' + data.id);
        if (data.created) parts.push('Created: ' + data.created);
        if (data.updated) parts.push('Updated: ' + data.updated);
        if (data.revision !== undefined) parts.push('Revision: ' + data.revision);
        info.textContent = parts.join(' | ');
      }
    }

    // Serialize form fields back to JSON
    function serializeFormToJson() {
      var data;
      try { data = JSON.parse(jsonTextarea.value); } catch(e) { data = {}; }
      document.querySelectorAll('[data-json-path]').forEach(function(el) {
        var path = el.getAttribute('data-json-path');
        var jsonType = el.getAttribute('data-json-type');
        var val;
        if (jsonType === 'bool') {
          val = el.checked;
        } else if (jsonType === 'number') {
          val = el.value === '' ? 0 : Number(el.value);
        } else {
          val = el.value;
          // Preserve null for optional fields — don't convert null to ""
          if (val === '' && getNestedValue(data, path) === null) {
            val = null;
          }
        }
        setNestedValue(data, path, val);
      });
      jsonTextarea.value = JSON.stringify(data, null, 2);
    }

    // Get nested value by dot path (handles hyphens in keys)
    function getNestedValue(obj, path) {
      var keys = path.split('.');
      var current = obj;
      for (var i = 0; i < keys.length; i++) {
        if (current === undefined || current === null) return undefined;
        current = current[keys[i]];
      }
      return current;
    }

    // Set nested value by dot path
    function setNestedValue(obj, path, value) {
      var keys = path.split('.');
      var current = obj;
      for (var i = 0; i < keys.length - 1; i++) {
        if (current[keys[i]] === undefined || current[keys[i]] === null) {
          current[keys[i]] = {};
        }
        current = current[keys[i]];
      }
      current[keys[keys.length - 1]] = value;
    }

    // Toggle between form and raw JSON
    window.toggleJsonView = function() {
      var rawPanel = document.getElementById('raw-json-panel');
      var formPanel = document.getElementById('structured-form-panel');
      var toggleBtn = document.getElementById('toggle-json-view');
      if (!rawPanel || !formPanel || !toggleBtn) return;

      if (rawPanel.style.display === 'none') {
        // Switching to raw JSON — serialize form first
        serializeFormToJson();
        rawPanel.style.display = '';
        formPanel.style.display = 'none';
        toggleBtn.textContent = 'Show Form';
      } else {
        // Switching to form — populate from JSON
        populateFormFromJson();
        rawPanel.style.display = 'none';
        formPanel.style.display = '';
        toggleBtn.textContent = 'Show Raw JSON';
      }
    };

    // On form submit, serialize form to JSON textarea
    var form = jsonTextarea.closest('form');
    if (form) {
      form.addEventListener('submit', function() {
        var formPanel = document.getElementById('structured-form-panel');
        if (formPanel && formPanel.style.display !== 'none') {
          serializeFormToJson();
        }
      });
    }

    // Initial population
    populateFormFromJson();
  })();
  </script>
</body>
</html>
